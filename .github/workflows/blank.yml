name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  workflow_dispatch:

jobs:
  generate:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2
        with:
          repository: 'P3-DAT3-03/Flea'
      - uses: suisei-cn/actions-download-file@v1
        id: downloaddocfx  # Remember to give an ID if you need the output filename
        name: Download docfx 
        with:
          url: "https://raw.githubusercontent.com/LowkeyCoding/WorkFlows/master/docfx.json"
          target: ./
      - uses: suisei-cn/actions-download-file@v1
        id: downloadfile  # Remember to give an ID if you need the output filename
        name: Download openapi.json
        with:
          url: "https://raw.githubusercontent.com/LowkeyCoding/WorkFlows/master/openapi.swagger.json"
          target: ./
      - name: Setup .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.x
      - name: Setup DocFx
        run: |
          nuget install docfx.console -Version 2.58.9
          mkdir .\docfx.console.2.58.9\tools\Plugins
          nuget install rest.tagpage -OutputDirectory .\docfx.console.2.58.9\tools\Plugins
      - name: Init DocFx Data
        run: |
          .\docfx.console.2.58.9\tools\docfx init -q -o Docs
          rm .\Docs\docfx.json
          mv ./docfx.json ./Docs
          mv ./openapi.swagger.json ./Docs/restapi
          mv ./Flea/* ./Docs/src
          cd ./Docs
          .\..\docfx.console.2.58.9\tools\docfx metadata
      - name: Generate Documentation
        run: |
          .\docfx.console.2.58.9\tools\docfx docfx.json
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./Docs/_site
          destination_dir: DOC
